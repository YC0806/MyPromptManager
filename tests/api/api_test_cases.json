{
  "base_url": "http://localhost:8000/v1",
  "default_headers": {
    "Content-Type": "application/json"
  },
  "variables": {
    "prompt_author": "integration.tester",
    "prompt_label": "test-run",
    "template_author": "integration.tester",
    "template_label": "test-template",
    "chat_tag": "test-chat"
  },
  "tests": [
    {
      "name": "health_status",
      "description": "检查 API 健康状态",
      "method": "GET",
      "path": "/health",
      "expected_status": 200,
      "assertions": [
        {
          "type": "field_in",
          "path": "status",
          "values": [
            "healthy",
            "unhealthy"
          ]
        },
        {
          "type": "field_exists",
          "path": "storage"
        }
      ]
    },
    {
      "name": "list_prompts",
      "description": "列出 prompt 列表，验证基础分页参数",
      "method": "GET",
      "path": "/prompts",
      "params": {
        "limit": 5
      },
      "expected_status": 200,
      "assertions": [
        {
          "type": "field_is_type",
          "path": "prompts",
          "value": "list"
        }
      ]
    },
    {
      "name": "create_prompt",
      "description": "创建一个新的 prompt 并保存 ID",
      "method": "POST",
      "path": "/prompts",
      "body": {
        "content": "---\ntitle: Prompt Regression {{run_id}}\ndescription: Regression prompt generated by automated tests\nslug: prompt-regression-{{run_id}}\nlabels:\n  - {{prompt_label}}\nauthor: {{prompt_author}}\n---\n\n# Prompt Regression {{run_id}}\n\nThis prompt was generated at {{iso_timestamp}} to verify the creation API.\n"
      },
      "expected_status": 201,
      "save": {
        "prompt_id": "id",
        "prompt_version": "version_id"
      },
      "assertions": [
        {
          "type": "field_exists",
          "path": "id"
        },
        {
          "type": "field_exists",
          "path": "version_id"
        }
      ]
    },
    {
      "name": "get_prompt",
      "description": "根据保存的 ID 获取 prompt 详情",
      "method": "GET",
      "path": "/prompts/{{prompt_id}}",
      "expected_status": 200,
      "assertions": [
        {
          "type": "field_equals",
          "path": "metadata.author",
          "value": "{{prompt_author}}"
        },
        {
          "type": "field_equals",
          "path": "metadata.slug",
          "value": "prompt-regression-{{run_id}}"
        }
      ]
    },
    {
      "name": "search_created_prompt",
      "description": "使用标签检索刚创建的 prompt",
      "method": "GET",
      "path": "/search",
      "params": {
        "type": "prompt",
        "labels": "{{prompt_label}}",
        "limit": 5
      },
      "expected_status": 200,
      "assertions": [
        {
          "type": "length_gte",
          "path": "items",
          "value": 1
        },
        {
          "type": "field_equals",
          "path": "items.0.id",
          "value": "{{prompt_id}}"
        }
      ]
    },
    {
      "name": "create_template",
      "description": "创建一个新的 template，并保存 ID",
      "method": "POST",
      "path": "/templates",
      "body": {
        "content": "---\ntitle: Template Scenario {{run_id}}\ndescription: Template created for automated coverage\nslug: template-scenario-{{run_id}}\nlabels:\n  - {{template_label}}\nauthor: {{template_author}}\n---\n\n# Template Scenario {{run_id}}\n\nThis template validates the template endpoints.\n"
      },
      "expected_status": 201,
      "save": {
        "template_id": "id"
      },
      "assertions": [
        {
          "type": "field_exists",
          "path": "id"
        }
      ]
    },
    {
      "name": "get_template",
      "description": "根据保存的 ID 获取 template 详情",
      "method": "GET",
      "path": "/templates/{{template_id}}",
      "expected_status": 200,
      "assertions": [
        {
          "type": "field_equals",
          "path": "metadata.author",
          "value": "{{template_author}}"
        }
      ]
    },
    {
      "name": "create_chat",
      "description": "创建带初始消息的 chat",
      "method": "POST",
      "path": "/chats",
      "body": {
        "title": "Chat Regression {{run_id}}",
        "description": "Covers chat creation API",
        "tags": [
          "{{chat_tag}}"
        ],
        "messages": [
          {
            "role": "user",
            "content": "Start regression chat {{run_id}}",
            "timestamp": "{{iso_timestamp}}"
          },
          {
            "role": "assistant",
            "content": "Acknowledged regression chat {{run_id}}",
            "timestamp": "{{iso_timestamp}}"
          }
        ]
      },
      "expected_status": 201,
      "save": {
        "chat_id": "id"
      },
      "assertions": [
        {
          "type": "field_exists",
          "path": "id"
        }
      ]
    },
    {
      "name": "update_chat",
      "description": "为现有 chat 追加消息并更新标签",
      "method": "PUT",
      "path": "/chats/{{chat_id}}",
      "body": {
        "title": "Chat Regression {{run_id}} (Updated)",
        "description": "Extended scenario coverage",
        "tags": [
          "{{chat_tag}}",
          "regression"
        ],
        "messages": [
          {
            "role": "user",
            "content": "Start regression chat {{run_id}}",
            "timestamp": "{{iso_timestamp}}"
          },
          {
            "role": "assistant",
            "content": "Acknowledged regression chat {{run_id}}",
            "timestamp": "{{iso_timestamp}}"
          },
          {
            "role": "user",
            "content": "Adding more detail for {{run_id}}",
            "timestamp": "{{iso_timestamp}}"
          }
        ]
      },
      "expected_status": 200,
      "assertions": [
        {
          "type": "field_exists",
          "path": "updated_at"
        }
      ]
    },
    {
      "name": "get_chat_after_update",
      "description": "验证 chat 更新后的消息数量和标签",
      "method": "GET",
      "path": "/chats/{{chat_id}}",
      "expected_status": 200,
      "assertions": [
        {
          "type": "field_equals",
          "path": "tags.1",
          "value": "regression"
        },
        {
          "type": "length_equals",
          "path": "messages",
          "value": 3
        }
      ]
    },
    {
      "name": "index_rebuild",
      "description": "触发一次索引重建流程",
      "method": "POST",
      "path": "/index/rebuild",
      "expected_status": 200,
      "assertions": [
        {
          "type": "field_equals",
          "path": "status",
          "value": "completed"
        }
      ]
    },
    {
      "name": "create_prompt_validation_error",
      "description": "触发缺少 content 字段的 400 错误",
      "method": "POST",
      "path": "/prompts",
      "body": {
        "content": ""
      },
      "expected_status": 400,
      "assertions": [
        {
          "type": "field_exists",
          "path": "detail"
        }
      ]
    }
  ]
}
